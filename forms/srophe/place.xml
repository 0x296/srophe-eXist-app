<html xmlns="http://www.w3.org/1999/xhtml" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:tei="http://www.tei-c.org/ns/1.0" xmlns:xf="http://www.w3.org/2002/xforms">
    <head>
        <title>Place Editor</title>
        <meta name="author" content="wsalesky at gmail.com"/>
        <meta name="description" content="Edit TEI Place records"/>
        <link rel="stylesheet" type="text/css" href="../resources/bootstrap/css/bootstrap.min.css"/>
        <link rel="stylesheet" type="text/css" href="resources/css/xforms.css"/>
        <link href="../resources/jquery-ui/jquery-ui.min.css" rel="stylesheet"/>
        <script type="text/javascript" src="../resources/js/jquery.min.js"/>
        <script type="text/javascript" src="../resources/bootstrap/js/bootstrap.min.js"/>
        <script type="text/javascript">
            <![CDATA[
                function getUrlParameter(param) {
                   return new URLSearchParams(window.location.search).get(param);
                 };
                 
                 //console.log(getUrlParameter('id'));
                 //to use: getUrlParameter('id'); 
            ]]>
        </script>
        <xf:model id="m-place">
            <!-- Load TEI record -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-rec" src="xml-templates/place.xml"/>
            <!-- Template used for building optional elements. May be a better way to handle that  -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-template" src="xml-templates/template.xml"/>
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-ctr-vals" src="xml-templates/controlled-vals.xml"/>
            <!-- For inserting date attributes -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-dates">
                <tei>
                    <state type="existence" from="" to="">
                        <label>Date</label>
                        <desc/>
                    </state>
                    <state type="existence" subtype="dynasty" source="" from="" to="">
                        <label>Dynasty</label>
                        <desc/>
                    </state>
                </tei>
            </xf:instance>
            <!-- Location instance -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-location">
                <tei:TEI>
                    <location type="" source=""/>
                    <location type="gps" source="">
                        <lat>latitude</lat>
                        <long>longitude</long>
                    </location>
                    <location type="relative" source="">
                        <desc/>
                    </location>
                    <location type="nested" source="">
                        <placeName xml:lang=""/>
                        <region type="province">
                            <placeName xml:lang=""/>
                        </region>
                        <region type="county-city">
                            <placeName xml:lang=""/>
                        </region>
                        <region type="political-subdivision">
                            <placeName xml:lang=""/>
                        </region>
                    </location>
                </tei:TEI>
            </xf:instance>
            <!-- Sources -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-source">
                <tei>
                    <tei:source source=""/>
                </tei>
            </xf:instance>
            <!-- For controlled vocab/bibl lookup  -->
            <xf:instance id="i-search">
                <root xmlns="">
                    <q/>
                    <idno/>
                    <element/>
                    <type/>
                </root>
            </xf:instance>
            <!-- For controlled vocab/bibl lookup  -->
            <xf:instance id="i-search-relation">
                <root xmlns="">
                    <q/>
                    <idno/>
                    <element/>
                    <type/>
                </root>
            </xf:instance>
            <!-- Controlled vocab  search results are loaded into this instance -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-search-results">
                <results>
                    <TEI>
                        <bibl ref="http://syriaca.org/bibl/">Enter search</bibl>
                    </TEI>
                </results>
            </xf:instance>
            <!-- Controlled vocab  the search results are loaded into this instance -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-selected">
                <results>
                    <TEI>
                        <title ref=""/>
                    </TEI>
                </results>
            </xf:instance>
            <!-- For selecting and populating bibl elements -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-new-bibl">
                <div>
                    <bibl xml:id="biblPlaceHolder"/>
                </div>
            </xf:instance>            
            <!-- Controlled vocab selected list -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-add-bibl">
                <bibl xml:id="bibnum">
                    <title level="citation"/>
                    <title/>
                    <author/>
                    <ptr target=""/>
                    <citedRange unit="pp"/>
                </bibl>
            </xf:instance>
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-add-relation">
                <result>
                    <relation passive=""/>    
                </result>
            </xf:instance>
            
            <!-- Set URI for editing -->
            <xf:instance xmlns="http://www.tei-c.org/ns/1.0" id="i-user-details">
                <change who="online-submission">
                    <name/>
                    <email/>
                    <comments/>    
                </change>
            </xf:instance>            
            <!-- For error messages from server -->  
            <xf:instance id="i-submission">
                <response status="success">
                    <message>Submission result</message>
                </response>
            </xf:instance>
            
            <!-- Look up sources  -->
            <xf:submission id="s-bibl-lookup" method="get" ref="instance('i-search')" replace="instance" instance="i-search-results" serialization="none" mode="synchronous">
                <xf:resource value="concat('services/controlled-vocab-search.xql?type=bibl&amp;','idno=',instance('i-search')//idno,'&amp;q=',instance('i-search')//q)"/>
            </xf:submission>
            <xf:submission id="s-relation-lookup" method="get" ref="instance('i-search-relation')" replace="instance" instance="i-search-results" serialization="none" mode="synchronous">
                <xf:resource value="concat('services/controlled-vocab-search.xql?q=',instance('i-search-relation')//q)"/>
            </xf:submission>
            
            <!-- Submissions -->
            <!-- Download -->
            <xf:submission id="s-download-xml" ref="instance('i-rec')" show="new" method="post" replace="all" action="form.xq?form=srophe/download.xml?type=download"/>
            
            <!-- Download -->
            <xf:submission id="s-view-xml" ref="instance('i-rec')" show="new" method="post" replace="all" action="services/submit.xql?type=view"/>
            
            <!-- Save -->
            <xf:submission id="s-save-old" resource="services/submit.xql?type=save" ref="instance('i-rec')" replace="instance" instance="i-submission" method="post">
                <xf:action ev:event="xforms-submit-done">
                    <xf:message ref="instance('i-submission')//*:message"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                    <xf:message ref="instance('i-submission')//*:message"/>
                </xf:action>
            </xf:submission> 
            
            <xf:submission id="s-save" ref="instance('i-rec')" replace="instance" instance="i-submission" action="services/submit.xql?type=save" method="post">
                <xf:action ev:event="xforms-submit-done">
                    <xf:message ref="instance('i-submission')//*:message"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                    <xf:message ref="instance('i-submission')//*:message"/>
                </xf:action>
            </xf:submission>
            
            <xf:submission id="s-github" ref="instance('i-rec')" replace="instance" instance="i-submission" action="services/submit.xql?type=github" method="post">
                <xf:action ev:event="xforms-submit-done">
                    <xf:message ref="instance('i-submission')//*:message"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                    <xf:message ev:event="xforms-submit-error" level="modal">Unable to submit your additions at this time, you may download your changes and email them to us.</xf:message>
                </xf:action>
            </xf:submission>
        </xf:model>
    </head>
    <body>       
        <div class="section xforms">
            <div class="accordion panel panel-info">
                <div class="panel-heading">
                    <h4 data-toggle="collapse" href="#collapseUserDetails" aria-expanded="false">User Details<span class="pull-right"> <span class="glyphicon glyphicon-chevron-right"/></span></h4>
                </div>
                <div id="collapseUserDetails" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <xf:group ref="instance('i-rec')//tei:respStmt[1]">
                            <xf:input ref="tei:name">
                                <xf:label>Your Name: </xf:label>
                                <xf:alert>This is a required field.</xf:alert>
                            </xf:input>
                            <xf:input ref="tei:email">
                                <xf:label>Your email: </xf:label>
                                <xf:alert>This is a required field.</xf:alert>
                            </xf:input>
                            <xf:input ref="tei:resp">
                                <xf:label>Editor Role: </xf:label>
                                <xf:alert>This is a required field.</xf:alert>
                            </xf:input>
                            <xf:textarea ref="tei:comments">
                                <xf:label>Comments: </xf:label>
                                <xf:alert>This is a required field.</xf:alert>
                            </xf:textarea>
                        </xf:group>
                    </div>
                </div>
            </div>
            <div class="accordion panel panel-info">
                <div class="panel-heading">
                    <h4 data-toggle="collapse" href="#collapseRecord" aria-expanded="false">Place
                        <span class="pull-right">
                            <span class="glyphicon glyphicon-chevron-right"/>
                        </span>
                    </h4>
                </div>
                <div id="collapseRecord" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <xf:group ref="instance('i-rec')//tei:place" id="place">
                            <div class="row tabbable">
                                <ul class="nav nav-pills nav-stacked col-md-2 col-sm-3">
                                    <li>
                                        <a href="#names" data-toggle="tab" class="active">Names</a>
                                    </li>
                                    <li>
                                        <a href="#desc" data-toggle="tab">Notes/Descriptions</a>
                                    </li>
                                    <li>
                                        <a href="#location" data-toggle="tab">Locations/Dates</a>
                                    </li>
                                    <li>
                                        <a href="#links" data-toggle="tab">Links</a>
                                    </li>
                                    <li>
                                        <a href="#sources" data-toggle="tab">Sources</a>
                                    </li>
                                </ul>
                                <div class="tab-content col-md-10 col-sm-9">
                                    <div class="tab-pane active" id="names">
                                        <h3>Place</h3> 
                                        <div class="form-inline">
                                            <xf:input ref="@xml:id">
                                                <xf:label>ID</xf:label>
                                            </xf:input>
                                            <xf:trigger class="btn btn-default add" appearance="minimal" ref="self::node()[not(@type)]">
                                                <xf:label>Type</xf:label>
                                                <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-template')//tei:place/@type"/>
                                            </xf:trigger>
                                            <span>
                                                <xf:select1 ref="@type">
                                                    <xf:label>Type</xf:label>
                                                    <xf:item>
                                                        <xf:label>--- Select Type ---</xf:label>
                                                        <xf:value/>
                                                    </xf:item>
                                                    <xf:itemset ref="instance('i-ctr-vals')//tei:placeTypes/tei:type">
                                                        <xf:label ref="."/>
                                                        <xf:value ref="."/>
                                                    </xf:itemset>
                                                </xf:select1>
                                            </span>
                                            <xf:select1 ref="tei:trait/@sub-type">
                                                <xf:label>Subtype</xf:label>
                                                <xf:item>
                                                    <xf:label>--- Select Subtype ---</xf:label>
                                                    <xf:value/>
                                                </xf:item>
                                                <xf:itemset ref="instance('i-ctr-vals')//tei:placeSubTypes/tei:type">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="."/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </div>
                                        <br/>
                                        <h3>Type</h3>
                                        <xf:repeat ref="tei:trait" id="new-trait">
                                            <xf:repeat ref="tei:desc" id="new-traitdesc">
                                                <xf:input ref=".">
                                                    <xf:label>Type</xf:label>
                                                </xf:input>
                                                <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::node()[not(@xml:lang)]">
                                                    <xf:label>Lang</xf:label>
                                                    <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-template')//tei:place/tei:placeName/@xml:lang"/>
                                                </xf:trigger>
                                                <span>
                                                    <xf:select1 ref="@xml:lang">
                                                        <xf:label>Lang</xf:label>
                                                        <xf:item>
                                                            <xf:label>--- Select Language ---</xf:label>
                                                            <xf:value/>
                                                        </xf:item>
                                                        <xf:itemset ref="instance('i-ctr-vals')//tei:langUsage[@xml:id='tcadrt']/tei:language">
                                                            <xf:label ref="."/>
                                                            <xf:value ref="@ident"/>
                                                        </xf:itemset>
                                                    </xf:select1>
                                                </span>
                                                <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                    <xf:label/>
                                                    <xf:delete ev:event="DOMActivate" ref="."/>
                                                </xf:trigger>  
                                            </xf:repeat>
                                            <xf:trigger class="btn add" appearance="minimal">
                                                <xf:label>New Type</xf:label>
                                                <xf:insert ev:event="DOMActivate" ref="tei:desc" at="last()" position="after" origin="instance('i-template')//tei:place/tei:trait/tei:desc[1]"/>
                                            </xf:trigger>
                                        </xf:repeat>
                                        <br/>
                                        <h3>Place Names 
                                            <a class="togglelink link btn-sm btn-info pull-right" style="margin-top:0;" data-toggle="collapse" data-target="#name-instructions" href="#name-instructions" data-text-swap="Show Instructions"> 
                                                Instructions </a>
                                        </h3>
                                        <div class="collapse in alert alert-warning" id="name-instructions">
                                            <p>Forthcomming</p>
                                        </div>
                                        <xf:repeat ref="tei:placeName" id="new-placeName">
                                            <fieldset>               
                                                <div class="form-inline">
                                                    <xf:input ref=".">
                                                        <xf:label>Name</xf:label>
                                                    </xf:input>
                                                    <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::node()[not(@xml:lang)]">
                                                        <xf:label>Lang</xf:label>
                                                        <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-template')//tei:place/tei:placeName/@xml:lang"/>
                                                    </xf:trigger>
                                                    <span>
                                                        <xf:select1 ref="@xml:lang">
                                                            <xf:label>Lang</xf:label>
                                                            <xf:item>
                                                                <xf:label>--- Select Language ---</xf:label>
                                                                <xf:value/>
                                                            </xf:item>
                                                            <xf:itemset ref="instance('i-ctr-vals')//tei:langUsage[@xml:id='tcadrt']/tei:language">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="@ident"/>
                                                            </xf:itemset>
                                                        </xf:select1>
                                                    </span>
                                                    <span>
                                                        <xf:select1 ref="@source" class="input-small">
                                                            <xf:label>Source:</xf:label>
                                                            <xf:itemset ref="instance('i-rec')//tei:text/descendant::tei:bibl">
                                                                <xf:label value="concat(tei:title[@level='citation'],' Cited Range: ', tei:citedRange, ' ',tei:citedRange/@unit)"/>
                                                                <xf:value ref="@xml:id"/>
                                                            </xf:itemset>
                                                        </xf:select1>
                                                        <!-- Add new source attribute if no source attribute -->
                                                        <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::*[not(@source)]">
                                                            <xf:label>source</xf:label>
                                                            <xf:insert ev:event="DOMActivate" context="." origin="instance('i-source')//tei:source/@source"/>
                                                        </xf:trigger>
                                                        <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                        <xf:trigger class="btn btn-default add btn-sm" appearance="minimal">
                                                            <xf:label>New Source</xf:label>
                                                            <xf:action ev:event="DOMActivate">
                                                                <xf:show dialog="new-source"/>
                                                            </xf:action>
                                                        </xf:trigger>
                                                    </span>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </div>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New Name</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="tei:placeName" at="last()" position="after" origin="instance('i-template')//tei:place/tei:placeName[1]"/>
                                        </xf:trigger>
                                        <h3>Featured Image
                                            <a class="togglelink link btn-sm btn-info pull-right" style="margin-top:0;" data-toggle="collapse" data-target="#image-instructions" href="#image-instructions" data-text-swap="Show Instructions"> 
                                                Instructions </a>
                                        </h3>
                                        <div class="collapse in alert alert-warning" id="image-instructions">
                                            <p>This URL should be the full URL to the image, example: https://farm5.staticflickr.com/4099/4822349222_4b4b990726_z.jpg</p>
                                        </div>
                                        <xf:repeat ref="../tei:listRelation/tei:relation[@ref='foaf:depicts']" id="new-featuredImage">
                                            <fieldset>      
                                                <!-- Load image if available -->
                                                <div class="form-inline">
                                                    <xf:input ref="@active">
                                                        <xf:label>Image URL:</xf:label>
                                                    </xf:input>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </div>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New Image</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="../tei:listRelation/tei:relation" at="last()" position="after" origin="instance('i-template')//tei:listPlace/tei:listRelation/tei:relation[@ref='foaf:depicts']"/>
                                        </xf:trigger>
                                    </div>
                                    <div class="tab-pane" id="desc">
                                        <h3>Description</h3>
                                        <xf:repeat ref="tei:desc" id="new-desc">
                                            <fieldset>
                                                <span class="text-area-attributes">
                                                    <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::node()[not(@xml:lang)]">
                                                        <xf:label>Lang</xf:label>
                                                        <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-template')//tei:place/tei:desc/@xml:lang"/>
                                                    </xf:trigger>
                                                    <span>
                                                        <xf:select1 ref="@xml:lang">
                                                            <xf:label>Lang</xf:label>
                                                            <xf:item>
                                                                <xf:label>--- Select Language ---</xf:label>
                                                                <xf:value/>
                                                            </xf:item>
                                                            <xf:itemset ref="instance('i-ctr-vals')//tei:langUsage[@xml:id='tcadrt']/tei:language">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="@ident"/>
                                                            </xf:itemset>
                                                        </xf:select1>
                                                    </span>
                                                    <xf:select1 ref="@source" class="input-small">
                                                        <xf:label>Source:</xf:label>
                                                        <xf:itemset ref="instance('i-rec')//tei:text/descendant::tei:bibl">
                                                            <xf:label value="concat(tei:title[@level='citation'],' Cited Range: ', tei:citedRange, ' ',tei:citedRange/@unit)"/>
                                                            <xf:value ref="@xml:id"/>
                                                        </xf:itemset>
                                                    </xf:select1>
                                                    <!-- Add new source attribute if no source attribute -->
                                                    <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::*[not(@source)]">
                                                        <xf:label>source</xf:label>
                                                        <xf:insert ev:event="DOMActivate" context="." origin="instance('i-source')//tei:source/@source"/>
                                                    </xf:trigger>
                                                    <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                    <xf:trigger class="btn btn-default add btn-sm" appearance="minimal">
                                                        <xf:label>New Source</xf:label>
                                                        <xf:action ev:event="DOMActivate">
                                                            <xf:show dialog="new-source"/>
                                                        </xf:action>
                                                    </xf:trigger>
                                                </span>
                                                <xf:textarea ref="." class="large"/>
                                                <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                    <xf:label/>
                                                    <xf:delete ev:event="DOMActivate" ref="."/>
                                                </xf:trigger>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New Description</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-template')//tei:place/tei:desc[1]"/>
                                        </xf:trigger>
                                        <hr/>
                                        <h3>Notes</h3>
                                        <xf:repeat ref="tei:note" id="new-note">
                                            <fieldset>
                                                <span class="text-area-attributes">
                                                    <xf:trigger class="btn btn-default add" appearance="minimal" ref="self::node()[not(@type)]">
                                                        <xf:label>Type</xf:label>
                                                        <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-template')//tei:place/tei:note/@type"/>
                                                    </xf:trigger>
                                                    <span>
                                                        <xf:select1 ref="@type">
                                                            <xf:label>Type</xf:label>
                                                            <xf:item>
                                                                <xf:label>--- Select Type ---</xf:label>
                                                                <xf:value/>
                                                            </xf:item>
                                                            <xf:itemset ref="instance('i-ctr-vals')//tei:notes/tei:type">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="."/>
                                                            </xf:itemset>
                                                        </xf:select1>
                                                    </span>
                                                    <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::node()[not(@xml:lang)]">
                                                        <xf:label>Lang</xf:label>
                                                        <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-template')//tei:place/tei:placeName/@xml:lang"/>
                                                    </xf:trigger>
                                                    <span>
                                                        <xf:select1 ref="@xml:lang">
                                                            <xf:label>Lang</xf:label>
                                                            <xf:item>
                                                                <xf:label>--- Select Language ---</xf:label>
                                                                <xf:value/>
                                                            </xf:item>
                                                            <xf:itemset ref="instance('i-ctr-vals')//tei:langUsage[@xml:id='tcadrt']/tei:language">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="@ident"/>
                                                            </xf:itemset>
                                                        </xf:select1>
                                                    </span>
                                                    <xf:select1 ref="@source" class="input-small">
                                                        <xf:label>Source:</xf:label>
                                                        <xf:itemset ref="instance('i-rec')//tei:text/descendant::tei:bibl">
                                                            <xf:label value="concat(tei:title[@level='citation'],' Cited Range: ', tei:citedRange, ' ',tei:citedRange/@unit)"/>
                                                            <xf:value ref="@xml:id"/>
                                                        </xf:itemset>
                                                    </xf:select1>
                                                    <!-- Add new source attribute if no source attribute -->
                                                    <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::*[not(@source)]">
                                                        <xf:label>source</xf:label>
                                                        <xf:insert ev:event="DOMActivate" context="." origin="instance('i-source')//tei:source/@source"/>
                                                    </xf:trigger>
                                                    <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                    <xf:trigger class="btn btn-default add btn-sm" appearance="minimal">
                                                        <xf:label>New Source</xf:label>
                                                        <xf:action ev:event="DOMActivate">
                                                            <xf:show dialog="new-source"/>
                                                        </xf:action>
                                                    </xf:trigger>
                                                </span>
                                                <xf:textarea ref="." class="large"/>
                                                <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                    <xf:label/>
                                                    <xf:delete ev:event="DOMActivate" ref="."/>
                                                </xf:trigger>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New Note</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-template')//tei:place/tei:note[1]"/>
                                        </xf:trigger>
                                    </div>
                                    <div class="tab-pane" id="location">
                                        <h3>Location</h3>
                                        <div>
                                            <xf:repeat ref="tei:location[tei:geo or tei:lat or tei:long]" id="new-geo">
                                                <fieldset>
                                                    <xf:input ref="tei:geo">
                                                        <xf:label>Coordinates</xf:label>
                                                        <xf:hint>*Enter latitude then longitude, seperated by a space.</xf:hint>
                                                    </xf:input>
                                                    <xf:input ref="tei:lat" class="input-sm">
                                                        <xf:label>Latitude</xf:label>
                                                    </xf:input>
                                                    <xf:input ref="tei:long" class="input-sm">
                                                        <xf:label>Longitude</xf:label>
                                                    </xf:input>
                                                    <span>
                                                        <xf:select1 ref="@source" class="input-small">
                                                            <xf:label>Source:</xf:label>
                                                            <xf:itemset ref="instance('i-rec')//tei:text/descendant::tei:bibl">
                                                                <xf:label value="concat(tei:title[@level='citation'],' Cited Range: ', tei:citedRange, ' ',tei:citedRange/@unit)"/>
                                                                <xf:value ref="@xml:id"/>
                                                            </xf:itemset>
                                                        </xf:select1> 
                                                        <!-- Add new source attribute if no source attribute 
                                                        <xf:trigger class="btn add" appearance="minimal" ref="self::*[not(@source)]">
                                                            <xf:label>Source</xf:label>
                                                            <xf:insert ev:event="DOMActivate" context="." origin="instance('i-source')//tei:source/@source"/>    
                                                        </xf:trigger> -->
                                                        <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                        <xf:trigger ref="@source" class="btn add" appearance="minimal">
                                                            <xf:label>New Source</xf:label>
                                                            <xf:action ev:event="DOMActivate">
                                                                <xf:show dialog="new-source"/>
                                                            </xf:action>
                                                        </xf:trigger>
                                                    </span>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </fieldset>
                                            </xf:repeat>                                        
                                            <xf:repeat ref="tei:location[@type='relative'][tei:desc]" id="new-location">
                                                <fieldset>
                                                    <xf:textarea ref="tei:desc">
                                                        <xf:label>Location</xf:label>
                                                    </xf:textarea>
                                                    <span>
                                                        <xf:select1 ref="@source" class="input-small">
                                                            <xf:label>Source:</xf:label>
                                                            <xf:itemset ref="instance('i-rec')//tei:text/descendant::tei:bibl">
                                                                <xf:label value="concat(tei:title[@level='citation'],' Cited Range: ', tei:citedRange, ' ',tei:citedRange/@unit)"/>
                                                                <xf:value ref="@xml:id"/>
                                                            </xf:itemset>
                                                        </xf:select1> 
                                                        <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                        <xf:trigger ref="@source" class="btn  add" appearance="minimal">
                                                            <xf:label>New Source</xf:label>
                                                            <xf:action ev:event="DOMActivate">
                                                                <xf:show dialog="new-source"/>
                                                            </xf:action>
                                                        </xf:trigger>
                                                    </span>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </fieldset>
                                            </xf:repeat>
                                            <xf:repeat ref="tei:location[@type='nested']" id="new-nestedLocation">
                                                <fieldset>
                                                    <span>
                                                        <xf:select1 ref="@source" class="input-small">
                                                            <xf:label>Source:</xf:label>
                                                            <xf:itemset ref="instance('i-rec')//tei:text//tei:bibl">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="@xml:id"/>
                                                            </xf:itemset>
                                                        </xf:select1> 
                                                        <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                        <xf:trigger ref="@source" class="btn  add" appearance="minimal">
                                                            <xf:label>New Source</xf:label>
                                                            <xf:action ev:event="DOMActivate">
                                                                <xf:show dialog="new-source"/>
                                                            </xf:action>
                                                        </xf:trigger>
                                                    </span>
                                                    <xf:repeat ref="tei:placeName" id="new-nestedLocation-placeName">
                                                        <fieldset>               
                                                            <div class="form-inline">
                                                                <xf:input ref=".">
                                                                    <xf:label>Name</xf:label>
                                                                </xf:input>
                                                                <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::node()[not(@xml:lang)]">
                                                                    <xf:label>Lang</xf:label>
                                                                    <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-location')//tei:location[@type='nested']/tei:placeName/@xml:lang"/>
                                                                </xf:trigger>
                                                                <span>
                                                                    <xf:select1 ref="@xml:lang">
                                                                        <xf:label>Lang</xf:label>
                                                                        <xf:item>
                                                                            <xf:label>--- Select Language ---</xf:label>
                                                                            <xf:value/>
                                                                        </xf:item>
                                                                        <xf:itemset ref="instance('i-ctr-vals')//tei:langUsage[@xml:id='tcadrt']/tei:language">
                                                                            <xf:label ref="."/>
                                                                            <xf:value ref="@ident"/>
                                                                        </xf:itemset>
                                                                    </xf:select1>
                                                                </span>
                                                                <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                                    <xf:label/>
                                                                    <xf:delete ev:event="DOMActivate" ref="."/>
                                                                </xf:trigger>
                                                            </div>
                                                        </fieldset>
                                                    </xf:repeat>
                                                    <xf:repeat ref="tei:region" id="new-nestedLocation-region">
                                                        <fieldset>               
                                                            <div class="form-inline">
                                                                <xf:input ref="@type">
                                                                    <xf:label>Region</xf:label>
                                                                </xf:input>
                                                                <xf:repeat ref="tei:placeName" id="new-nestedLocation-region-placeName">
                                                                    <fieldset>               
                                                                        <div class="form-inline">
                                                                            <xf:input ref=".">
                                                                                <xf:label>Name</xf:label>
                                                                            </xf:input>
                                                                            <xf:trigger class="btn btn-default add btn-sm" appearance="minimal" ref="self::node()[not(@xml:lang)]">
                                                                                <xf:label>Lang</xf:label>
                                                                                <xf:insert ev:event="DOMActivate" context="." at="." origin="instance('i-location')//tei:location[@type='nested']/tei:placeName/@xml:lang"/>
                                                                            </xf:trigger>
                                                                            <span>
                                                                                <xf:select1 ref="@xml:lang">
                                                                                    <xf:label>Lang</xf:label>
                                                                                    <xf:item>
                                                                                        <xf:label>--- Select Language ---</xf:label>
                                                                                        <xf:value/>
                                                                                    </xf:item>
                                                                                    <xf:itemset ref="instance('i-ctr-vals')//tei:langUsage[@xml:id='tcadrt']/tei:language">
                                                                                        <xf:label ref="."/>
                                                                                        <xf:value ref="@ident"/>
                                                                                    </xf:itemset>
                                                                                </xf:select1>
                                                                            </span>
                                                                            <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                                                <xf:label/>
                                                                                <xf:delete ev:event="DOMActivate" ref="."/>
                                                                            </xf:trigger>
                                                                        </div>
                                                                    </fieldset>
                                                                </xf:repeat>

                                                                <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                                    <xf:label/>
                                                                    <xf:delete ev:event="DOMActivate" ref="."/>
                                                                </xf:trigger>
                                                            </div>
                                                        </fieldset>
                                                    </xf:repeat>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </fieldset>
                                            </xf:repeat>
                                        </div> 
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>Add Coordinates</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-location')//tei:location[@type = 'gps']"/>
                                        </xf:trigger>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>Add Location Description</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-location')//tei:location[@type = 'relative'][1]"/>
                                        </xf:trigger>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>Add Nested Location</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-location')//tei:location[@type = 'nested'][1]"/>
                                        </xf:trigger>
                                        <hr/>
                                        <h3>Date</h3>
                                        <xf:repeat ref="tei:state[@type='existence'][not(@subtype='dynasty')]" id="new-existence">
                                            <fieldset>
                                                <xf:input ref="tei:desc">
                                                    <xf:label>Description</xf:label>
                                                </xf:input>
                                                <xf:input ref="@from">
                                                    <xf:label>From</xf:label>
                                                </xf:input>
                                                <xf:input ref="@to">
                                                    <xf:label>To</xf:label>
                                                </xf:input>
                                                <span>
                                                    <xf:select1 ref="@source" class="input-small">
                                                        <xf:label>Source:</xf:label>
                                                        <xf:itemset ref="instance('i-rec')//tei:text/descendant::tei:bibl">
                                                            <xf:label value="concat(tei:title[@level='citation'],' Cited Range: ', tei:citedRange, ' ',tei:citedRange/@unit)"/>
                                                            <xf:value ref="@xml:id"/>
                                                        </xf:itemset>
                                                    </xf:select1> 
                                                    <!-- Add new source attribute if no source attribute 
                                                        <xf:trigger class="btn add" appearance="minimal" ref="self::*[not(@source)]">
                                                            <xf:label>Source</xf:label>
                                                            <xf:insert ev:event="DOMActivate" context="." origin="instance('i-source')//tei:source/@source"/>    
                                                        </xf:trigger> -->
                                                    <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                    <xf:trigger ref="@source" class="btn add" appearance="minimal">
                                                        <xf:label>New Source</xf:label>
                                                        <xf:action ev:event="DOMActivate">
                                                            <xf:show dialog="new-source"/>
                                                        </xf:action>
                                                    </xf:trigger>
                                                </span>
                                                <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                    <xf:label/>
                                                    <xf:delete ev:event="DOMActivate" ref="."/>
                                                </xf:trigger>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>Add Date</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-dates')//tei:state[@type = 'existence'][1]"/>
                                        </xf:trigger>
                                        <h3>Dynasty</h3>
                                        <xf:repeat ref="tei:state[@type='existence'][@subtype='dynasty']" id="new-dynasty">
                                            <fieldset>
                                                <xf:input ref="tei:desc">
                                                    <xf:label>Description</xf:label>
                                                </xf:input>
                                                <xf:input ref="@from">
                                                    <xf:label>From</xf:label>
                                                </xf:input>
                                                <xf:input ref="@to">
                                                    <xf:label>To</xf:label>
                                                </xf:input>
                                                <span>
                                                    <xf:select1 ref="@source" class="input-small">
                                                        <xf:label>Source:</xf:label>
                                                        <xf:itemset ref="instance('i-rec')//tei:text/descendant::tei:bibl">
                                                            <xf:label value="concat(tei:title[@level='citation'],' Cited Range: ', tei:citedRange, ' ',tei:citedRange/@unit)"/>
                                                            <xf:value ref="@xml:id"/>
                                                        </xf:itemset>
                                                    </xf:select1> 
                                                    <!-- Add new source popup Use xf:dialog (consider subform?) -->
                                                    <xf:trigger ref="@source" class="btn add" appearance="minimal">
                                                        <xf:label>New Source</xf:label>
                                                        <xf:action ev:event="DOMActivate">
                                                            <xf:show dialog="new-source"/>
                                                        </xf:action>
                                                    </xf:trigger>
                                                </span>
                                                <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                    <xf:label/>
                                                    <xf:delete ev:event="DOMActivate" ref="."/>
                                                </xf:trigger>
                                            </fieldset>
                                        </xf:repeat>
                                        
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>Add Dynasty</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-dates')//tei:state[@subtype = 'dynasty'][1]"/>
                                        </xf:trigger>
                                    </div>
                                    <div class="tab-pane" id="links">
                                        <xf:group ref="instance('i-rec')//tei:listRelation" id="relations">
                                        <h3>Contained in Place
                                            <a class="togglelink link btn-sm btn-info pull-right" style="margin-top:0;" data-toggle="collapse" data-target="#place-instructions" href="#place-instructions" data-text-swap="Show Instructions"> 
                                                Instructions </a>
                                        </h3>
                                        <div class="collapse in alert alert-warning" id="place-instructions">
                                            <p>This URL should be the full URL to the place, example: https://architecturasinica.org/place/000124</p>
                                        </div>
                                        <xf:repeat ref="tei:relation[@ref='schema:containedInPlace']" id="new-placeSubject">
                                            <fieldset>      
                                                <!-- Load image if available -->
                                                <div class="form-inline">
                                                    <xf:input ref="@active">
                                                        <xf:label>Place URL:</xf:label>
                                                    </xf:input>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </div>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New Contained in Place</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="tei:relation" at="last()" position="after" origin="instance('i-template')//tei:listPlace/tei:listRelation/tei:relation[@ref='schema:containedInPlace']"/>
                                        </xf:trigger>
                                        <h3>Subject
                                            <a class="togglelink link btn-sm btn-info pull-right" style="margin-top:0;" data-toggle="collapse" data-target="#subject-instructions" href="#subject-instructions" data-text-swap="Show Instructions"> 
                                                Instructions </a>
                                        </h3>
                                        <div class="collapse in alert alert-warning" id="subject-instructions">
                                            <p>This URL should be the full URL to the subject, example: https://architecturasinica.org/keyword/k000103</p>
                                        </div>
                                        <xf:repeat ref="tei:relation[@ref='dcterms:subject']" id="new-subject">
                                            <fieldset>      
                                                <div class="form-inline">
                                                    <xf:input ref="@active">
                                                        <xf:label>Subject URL:</xf:label>
                                                    </xf:input>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </div>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New Subject</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="tei:relation" at="last()" position="after" origin="instance('i-template')//tei:listPlace/tei:listRelation/tei:relation[@ref='dcterms:subject']"/>
                                        </xf:trigger>
                                        <h3>Dynasty
                                            <a class="togglelink link btn-sm btn-info pull-right" style="margin-top:0;" data-toggle="collapse" data-target="#dynasty-instructions" href="#dynasty-instructions" data-text-swap="Show Instructions"> 
                                                Instructions </a>
                                        </h3>
                                        <div class="collapse in alert alert-warning" id="dynasty-instructions">
                                            <p>This URL should be the full URL to the dynasty, example: https://architecturasinica.org/keyword/k000103</p>
                                        </div>
                                        <xf:repeat ref="tei:relation[@ref='dcterms:temporal']" id="new-dynastyLink">
                                            <fieldset>      
                                                <!-- Load image if available -->
                                                <div class="form-inline">
                                                    <xf:input ref="@active">
                                                        <xf:label>Dynasty URL:</xf:label>
                                                    </xf:input>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </div>
                                            </fieldset>
                                        </xf:repeat>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New dynasty</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="tei:relation" at="last()" position="after" origin="instance('i-template')//tei:listPlace/tei:listRelation/tei:relation[@ref='dcterms:temporal']"/>
                                        </xf:trigger>
                                        </xf:group>
                                    </div>
                                    <div class="tab-pane" id="sources">
                                        <h3>Sources
                                            <a class="togglelink link btn-sm btn-info pull-right" style="margin-top:0;" data-toggle="collapse" data-target="#location-instructions" href="#sources-instructions" data-text-swap="Show Instructions"> 
                                                Instructions </a>
                                        </h3>
                                        <div class="collapse in alert alert-warning" id="sources-instructions">
                                            <p>If you would like to add an information source (e.g. an archival document, a published document, 
                                                an ethnographic citation), then simply click New Source and add the citation information. 
                                                Sources can be added as a text citation or as a link to a source in the existing bibliography. To link to an existing source
                                                please use the "Find source" button.</p>
                                        </div>
                                        <div>
                                            <!-- Review and delete bibl records -->
                                            <xf:repeat ref="tei:bibl">
                                                <fieldset>
                                                    <xf:repeat ref="tei:title[@level='citation']" id="source-view-citation">
                                                        <xf:input ref=".">
                                                            <xf:label class="inline">Citation: </xf:label>
                                                        </xf:input>
                                                    </xf:repeat>
                                                    <xf:repeat ref="tei:title[not(@level='citation')]" id="source-view-title">
                                                        <xf:input ref=".">
                                                            <xf:label class="inline">Title: </xf:label>
                                                        </xf:input>
                                                        <xf:input ref="@level">
                                                            <xf:label class="inline">Level: </xf:label>
                                                        </xf:input>
                                                    </xf:repeat>
                                                    <xf:repeat ref="tei:author" id="source-view-auth">
                                                        <xf:input ref=".">
                                                            <xf:label class="inline">Author: </xf:label>
                                                        </xf:input>
                                                    </xf:repeat>
                                                    <xf:repeat ref="tei:editor" id="source-view-editor">
                                                        <xf:input ref=".">
                                                            <xf:label class="inline">Editor: </xf:label>
                                                        </xf:input>
                                                    </xf:repeat>
                                                    <xf:repeat ref="tei:citedRange" id="source-view-citedRange">
                                                        <xf:input ref=".">
                                                            <xf:label class="inline">Cited Range: </xf:label>
                                                        </xf:input>
                                                    </xf:repeat>
                                                    <xf:trigger appearance="minimal" class="btn remove pull-right">
                                                        <xf:label/>
                                                        <xf:delete ev:event="DOMActivate" ref="."/>
                                                    </xf:trigger>
                                                </fieldset>
                                            </xf:repeat>
                                        </div>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>New source</xf:label>
                                            <xf:insert ev:event="DOMActivate" ref="child::*" origin="instance('i-template')//tei:entryFree/tei:bibl[1]"/>
                                        </xf:trigger>
                                        <xf:trigger class="btn add" appearance="minimal">
                                            <xf:label>Find source</xf:label>
                                            <xf:action ev:event="DOMActivate">
                                                <xf:show dialog="new-source"/>
                                            </xf:action>
                                        </xf:trigger>
                                    </div>
                                </div>
                                <div>
                                    <xf:dialog id="new-source" class="modal">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <xf:trigger class="btn btn-default modal-close pull-right top" appearance="minimal">
                                                    <xf:label> </xf:label>
                                                    <xf:action ev:event="DOMActivate">
                                                        <xf:hide dialog="new-source"/>
                                                    </xf:action>
                                                </xf:trigger>
                                                <br/>
                                            </div>
                                            <div class="modal-body" style="background-color:white;">
                                                <h4>Search bibliography for source:</h4>
                                                <xf:group class="input-md input-group">
                                                    <xf:input id="search-q" ref="instance('i-search')/q" incremental="true">
                                                        <xf:label>Search Source Keywords: </xf:label>
                                                        <!-- for each key press send the s1 search out -->
                                                        <xf:send submission="s-bibl-lookup" ev:event="xforms-value-changed" ref="string-length(instance('i-search')/q) &gt; 2" class="input-group-btn"/>
                                                    </xf:input>
                                                </xf:group>
                                                <xf:group class="input-md input-group">
                                                    <xf:input id="search-id" ref="instance('i-search')/idno" incremental="true">
                                                        <xf:label>Search URI: </xf:label>
                                                        <!-- for each key press send the s1 search out -->
                                                        <xf:send submission="s-bibl-lookup" ev:event="xforms-value-changed" ref="string-length(instance('i-search')/idno) &gt; 2" class="input-group-btn"/>
                                                    </xf:input>
                                                </xf:group>
                                                <xf:select1 ref="instance('i-selected')/tei:TEI/child::*/@ref" appearance="full" class="checkbox select-group">
                                                    <xf:itemset ref="instance('i-search-results')/tei:TEI">
                                                        <xf:label ref="tei:bibl/tei:title[@level='citation']"/>
                                                        <xf:value ref="tei:bibl/@ref"/>
                                                    </xf:itemset>
                                                    <!-- Insert selected element into i-selected, delete place holder node -->
                                                    <xf:action ev:event="xforms-value-changed">
                                                        <!-- Error, on setvalue, non numeric bibls?  -->
                                                        <xf:insert ev:event="DOMActivate" ref="instance('i-add-bibl')" origin="instance('i-search-results')/tei:TEI/child::*[@ref = instance('i-selected')/tei:TEI/child::*/@ref]"/>
                                                        <!--
                                                        <xf:setvalue ref="instance('i-add-bibl')//tei:title[@level='citation']" value="instance('i-search-results')/tei:TEI/child::*[@ref = instance('i-selected')/tei:TEI/child::*/@ref]/descendant-or-self::tei:label[1]"/>
                                                        <xf:setvalue ref="instance('i-add-bibl')/@xml:id" value="concat('bibl-',count(instance('i-rec')/descendant::tei:body/descendant::tei:bibl) + 1)"/>
                                                        <xf:setvalue ref="instance('i-add-bibl')//tei:ptr/@target" value="instance('i-selected')/tei:TEI/child::*/@ref"/>
                                                        <xf:setvalue ref="instance('i-add-bibl')//tei:title" value="instance('i-search-results')/tei:TEI/child::*[@ref = instance('i-selected')/tei:TEI/child::*/@ref]/tei:title[1]"/>
                                                        <xf:setvalue ref="instance('i-add-bibl')//tei:author" value="instance('i-search-results')/tei:TEI/child::*[@ref = instance('i-selected')/tei:TEI/child::*/@ref]/tei:author[1]"/>
                                                        -->
                                                    </xf:action>
                                                </xf:select1>
                                                <xf:group class="horiz-tab-menu">
                                                    <xf:trigger appearance="minimal" class="tabs view">
                                                        <xf:label>View Selection </xf:label>
                                                        <xf:toggle case="view-selected" ev:event="DOMActivate"/>
                                                    </xf:trigger>
                                                    <xf:trigger appearance="minimal" class="tabs edit">
                                                        <xf:label>Edit Selection </xf:label>
                                                        <xf:toggle case="edit-selected" ev:event="DOMActivate"/>
                                                    </xf:trigger>
                                                    <xf:trigger class="btn save" appearance="minimal">
                                                        <xf:label> Add to Document </xf:label>
                                                        <xf:action ev:event="DOMActivate">
                                                            <xf:insert ref="tei:bibl" at="last()" position="after" origin="instance('i-add-bibl')"/>
                                                            <xf:setvalue ref="instance('i-search')/q" value="''"/>
                                                            <xf:delete ref="instance('i-search-results')//tei:TEI"/>
                                                            <xf:delete ref="instance('i-add-bibl')//tei:bibl"/>
                                                            <xf:hide dialog="new-source"/>
                                                        </xf:action>
                                                        <xf:message level="modal" ev:event="DOMActivate">Saved!</xf:message>
                                                    </xf:trigger>
                                                </xf:group>
                                                <xf:switch id="review" class="tab-panel">
                                                    <xf:case id="view-selected" selected="true()">
                                                        <xf:group class="view">
                                                            <xf:output ref="instance('i-add-bibl')//tei:title[@level='citation']">
                                                                <xf:label>Citation: </xf:label>
                                                            </xf:output>
                                                            <br/>
                                                            <xf:output ref="instance('i-add-bibl')//tei:ptr/@target">
                                                                <xf:label>ID: </xf:label>
                                                            </xf:output>
                                                        </xf:group>
                                                    </xf:case>
                                                    <xf:case id="edit-selected">
                                                        <xf:group class="edit">
                                                            <xf:repeat ref="instance('i-add-bibl')//tei:title[@level='citation']" id="new-sourceTitleCitation">
                                                                <xf:input ref="." class="input-md">
                                                                    <xf:label class="inline">Citation: </xf:label>
                                                                </xf:input>
                                                            </xf:repeat>
                                                            <xf:repeat ref="instance('i-add-bibl')//tei:title[not(@level)]" id="new-sourceTitle">
                                                                <xf:input ref="." class="input-md">
                                                                    <xf:label class="inline">Title: </xf:label>
                                                                </xf:input>
                                                            </xf:repeat>
                                                            <xf:repeat ref="instance('i-add-bibl')//tei:author" id="new-sourceAuthor">
                                                                <xf:input ref="." class="input-md">
                                                                    <xf:label class="inline">Author: </xf:label>
                                                                </xf:input>
                                                            </xf:repeat>
                                                            <br/>
                                                            <xf:input ref="instance('i-add-bibl')//tei:citedRange" class="input-md">
                                                                <xf:label class="inline">Cited Range: </xf:label>
                                                            </xf:input>
                                                            <br/>
                                                            <xf:select1 ref="instance('i-add-bibl')//tei:citedRange/@unit" class="input-small">
                                                                <xf:label>Cited Range Unit:</xf:label>
                                                                <xf:itemset ref="instance('i-ctr-vals')//tei:citedRange/tei:unit">
                                                                    <xf:label ref="."/>
                                                                    <xf:value ref="."/>
                                                                </xf:itemset>
                                                            </xf:select1>
                                                        </xf:group>
                                                    </xf:case>
                                                </xf:switch>
                                            </div>
                                        </div>
                                    </xf:dialog>
                                    <xf:dialog id="new-relation" class="modal">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <xf:trigger class="btn btn-default modal-close pull-right top" appearance="minimal">
                                                    <xf:label> </xf:label>
                                                    <xf:action ev:event="DOMActivate">
                                                        <xf:hide dialog="new-relation"/>
                                                    </xf:action>
                                                </xf:trigger>
                                                <br/>
                                            </div>
                                            <div class="modal-body" style="background-color:white;">
                                                <h4>Search Architectura Sinica for place/keywords:</h4>
                                                <xf:group class="input-md input-group">
                                                    <xf:input id="relation-q" ref="instance('i-search-relation')/q" incremental="true">
                                                        <xf:label>search: </xf:label>
                                                        <xf:send submission="s-relation-lookup" ev:event="xforms-value-changed" ref="string-length(instance('i-search-relation')/q) &gt; 3" class="input-group-btn"/>
                                                    </xf:input>
                                                </xf:group>
                                                <xf:select1 ref="instance('i-selected')/tei:TEI/child::*/@ref" appearance="full" class="checkbox select-group">
                                                    <xf:itemset ref="instance('i-search-results')//tei:TEI">
                                                        <xf:label ref="child::*"/>
                                                        <xf:value ref="child::*/@ref"/>
                                                    </xf:itemset>
                                                    <xf:action ev:event="xforms-value-changed">
                                                        <xf:setvalue ref="instance('i-add-relation')//tei:relation/@passive" value="instance('i-selected')//tei:TEI/child::*/@ref"/>
                                                    </xf:action>
                                                </xf:select1>
                                                <xf:trigger class="btn save add" appearance="minimal">
                                                    <xf:label>Add to Document </xf:label>
                                                    <xf:insert ev:event="DOMActivate" ref="tei:relation" origin="instance('i-add-relation')//tei:relation"/>
                                                    <xf:message level="modal" ev:event="DOMActivate">Saved!</xf:message>
                                                </xf:trigger>
                                            </div>
                                        </div>
                                    </xf:dialog>
                                </div>
                            </div>
                        </xf:group>
                    </div>
                </div>
            </div>             
            <div class="section pull-right">
                <xf:submit class="btn btn-default" submission="s-github" appearance="minimal">
                    <xf:label><span class="glyphicon glyphicon-save-file"/> Submit</xf:label>
                </xf:submit>
                <!--
                <xf:submit class="btn btn-default" submission="s-download-xml" appearance="minimal">
                    <xf:label>
                        <span class="glyphicon glyphicon-save-file"/> Download XML</xf:label>
                </xf:submit>
                -->
                <xf:submit class="btn btn-default" submission="s-download-xml" appearance="minimal">
                    <xf:label><span class="glyphicon glyphicon-save-file"/> Download XML</xf:label>
                </xf:submit>
                <!--
                <xf:submit class="btn btn-default" submission="s-save" appearance="minimal">
                    <xf:label>
                        <span class="glyphicon glyphicon-save-file"/> Submit</xf:label>
                </xf:submit>
                <xf:submit class="btn btn-default" submission="s-github" appearance="minimal">
                    <xf:label>
                        <span class="glyphicon glyphicon-save-file"/> GitHub XML</xf:label>
                </xf:submit>
                <xf:submit class="btn btn-default" submission="s-download-xml" appearance="minimal">
                    <xf:label>
                        <span class="glyphicon glyphicon-save-file"/> Download XML</xf:label>
                </xf:submit>
                <xf:submit class="btn btn-default" submission="s-view-xml" appearance="minimal">
                    <xf:label>
                        <span class="glyphicon glyphicon-save-file"/> View XML</xf:label>
                </xf:submit>
                -->
            </div>
        </div> 
 </body>
</html>